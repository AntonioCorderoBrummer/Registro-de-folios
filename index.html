<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Verificador de N√∫meros üî¢</title>
  <style>
    body {
      font-family: sans-serif;
      max-width: 600px;
      margin: 40px auto;
    }
    #lista {
      border: 1px solid #ccc;
      padding: 10px;
      min-height: 100px;
    }
    #estado {
      margin-top: 20px;
      font-weight: bold;
    }
    input[type="text"] {
      width: 100%;
      padding: 10px;
      margin-top: 10px;
      font-size: 1em;
    }
    button {
      margin-top: 10px;
      margin-right: 10px;
      padding: 10px;
      font-size: 1em;
      background-color: #eee;
      border: 1px solid #aaa;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <h1>Verificador de N√∫meros üî¢</h1>

  <div id="lista">
    <strong>N√∫meros ingresados:</strong>
    <ul id="numeros"></ul>
  </div>

  <input type="text" id="inputNumero" placeholder="Ingresa un n√∫mero" />
  <div id="estado">Autenticando...</div>
  <button onclick="borrarUltimo()">‚Ü©Ô∏è Borrar √∫ltimo</button>
  <button onclick="solicitarBorrado()">üßπ Limpiar lista (solo admin)</button>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyDe0bmw3ekpgFj3L_T1zvoh4DrScXCaWdI",
      authDomain: "verificador-numero.firebaseapp.com",
      databaseURL: "https://verificador-numero-default-rtdb.firebaseio.com",
      projectId: "verificador-numero",
      storageBucket: "verificador-numero.firebasestorage.app",
      messagingSenderId: "255791592832",
      appId: "1:255791592832:web:4e2681121e27eddab2bd65"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const auth = firebase.auth();

    const input = document.getElementById("inputNumero");
    const estado = document.getElementById("estado");
    const lista = document.getElementById("numeros");

    let ultimoIngresado = null;
    let currentUID = null;

    // Esperar resultado de redirecci√≥n (solo la primera vez)
    auth.getRedirectResult()
      .then((result) => {
        if (result.user) {
          currentUID = result.user.uid;
          console.log("‚úÖ UID del administrador:", currentUID);
          estado.textContent = `üëã Bienvenido ${result.user.displayName}`;
          estado.style.color = "blue";
        } else {
          // Si no hay sesi√≥n, redirige a iniciar
          const provider = new firebase.auth.GoogleAuthProvider();
          auth.signInWithRedirect(provider);
        }
      })
      .catch((error) => {
        console.error("‚ùå Error al autenticar:", error);
        estado.textContent = "‚ö†Ô∏è Error al autenticar.";
        estado.style.color = "red";
      });

    // Mostrar lista de n√∫meros
    db.ref("numeros").on("value", (snapshot) => {
      lista.innerHTML = "";
      const data = snapshot.val();
      if (data) {
        const claves = Object.keys(data).sort();
        claves.forEach((n) => {
          const li = document.createElement("li");
          li.textContent = n;
          lista.appendChild(li);
        });
        ultimoIngresado = claves[claves.length - 1];
      } else {
        ultimoIngresado = null;
      }
    });

    input.addEventListener("keydown", function (e) {
      if (e.key === "Enter") {
        const valor = input.value.trim();
        if (!valor) return;

        const numeroRef = db.ref("numeros/" + valor);
        numeroRef.once("value", (snapshot) => {
          if (snapshot.exists()) {
            estado.textContent = "‚ùå N√∫mero ya usado.";
            estado.style.color = "red";
          } else {
            numeroRef.set(true);
            estado.textContent = "‚úÖ N√∫mero disponible.";
            estado.style.color = "green";
            ultimoIngresado = valor;
          }
          input.value = "";
        });
      }
    });

    function borrarUltimo() {
      if (ultimoIngresado) {
        db.ref("numeros/" + ultimoIngresado).remove();
        estado.textContent = `‚ùå N√∫mero eliminado: ${ultimoIngresado}`;
        estado.style.color = "orange";
      } else {
        estado.textContent = "‚ö†Ô∏è No hay n√∫meros para borrar.";
        estado.style.color = "gray";
      }
    }

    function solicitarBorrado() {
      if (!auth.currentUser) {
        estado.textContent = "‚ö†Ô∏è Debes iniciar sesi√≥n para borrar.";
        estado.style.color = "red";
        return;
      }

      db.ref("control/borrado").set({
        por: currentUID,
        fecha: new Date().toISOString()
      });

      db.ref("numeros").remove();
      estado.textContent = "üßπ Lista borrada por el administrador.";
      estado.style.color = "blue";
    }
  </script>
</body>
</html>
